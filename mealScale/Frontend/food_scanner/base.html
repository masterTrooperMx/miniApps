<!DOCTYPE html>
<html lang="es">
<head>
  <script>
    const token = localStorage.getItem("access_token");

    if (!token) {
      // No hay sesi√≥n ‚Üí regresar a login
      window.location.href = "/login.html";
    }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Analizador Nutricional por Imagen</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <!-- HEADER -->
  <header class="py-2">
    <div class="container-fluid px-3 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <div class="logo-badge">
          <img src="img/ms_logo.svg" class="logo" />
        </div>
        <div>
          <h1 class="h6 mb-0">NutriVision</h1>
          <p class="mb-0 small opacity-75">An√°lisis nutricional por foto</p>
        </div>
      </div>
      <span id="user-email" class="small text-muted"></span>
      <span class="badge badge-soft text-uppercase small">beta</span>
      <button id="logoutBtn" class="btn btn-sm btn-outline-secondary">
        Cerrar sesi√≥n
      </button>
    </div>
  </header>

  <!-- NAV -->
    <nav class="px-3 py-2" aria-label="breadcrumb">
        <div class="d-flex justify-content-between align-items-center">

            <!-- Breadcrumb tipo flecha -->
            <ol id="breadcrumb-steps" class="breadcrumb breadcrumb-arrow mb-0 flex-grow-1 me-3">
                
                <li class="breadcrumb-item">
                <a href="#">
                    <i class="bi bi-house-door-fill me-1"></i> Inicio
                </a>
                </li>

                <li class="breadcrumb-item">
                <a href="#">Analizar platillo</a>
                </li>

                <li class="breadcrumb-item active" aria-current="page">
                Nuevo an√°lisis
                </li>

            </ol>

            <!-- Toggle de tema -->
            <div class="ms-3 d-flex align-items-center gap-2 theme-toggle">
              <i id="themeIcon" class="bi bi-lightbulb-fill fs-5"></i>
              <input
                class="form-check-input m-0"
                type="checkbox"
                id="themeToggle">
            </div>
        </div>
    </nav>

  <!-- MAIN -->
  <main>
    <div class="container-fluid px-0">
      <div class="row g-3">

        <!-- ASIDE -->
        <aside class="col-12 col-lg-6">
          <div class="card-soft p-3">

            <div class="card-soft-header d-flex justify-content-between align-items-center">
              <i class="bi bi-cloud"></i>
              <span class="aside-title">Nuevo an√°lisis</span>
              <span class="badge-soft rounded-pill px-2 py-1">Paso 1</span>
            </div>

            <!-- C√ÅMARA -->
            <div id="camera-container" class="mb-3" style="display:none; position:relative;">
                
                <video id="camera-video" autoplay playsinline 
                    style="width:100%; border-radius:14px;"></video>

                <!-- Overlay -->
                <div id="camera-overlay"
                    style="
                        position:absolute;
                        top:0; left:0;
                        width:100%; height:100%;
                        border:4px solid rgba(255,255,255,0.6);
                        border-radius:20px;
                        box-sizing:border-box;
                        pointer-events:none;
                    ">
                </div>

                <!-- Bot√≥n din√°mico -->
                <button id="action-btn" class="btn btn-primary-soft w-100 mt-3">
                    <i class="bi bi-camera-fill"></i> Tomar foto
                </button>
            </div>

            <!-- Vista previa -->
            <div id="preview-container" class="mb-3" style="display:none;">
                <img id="preview-image" src="" class="img-fluid rounded" alt="Vista previa">
                
                <button id="action-btn-preview" class="btn btn-secondary w-100 mt-2">
                    <i class="bi bi-arrow-counterclockwise"></i> Tomar otra foto
                </button>
            </div>

            <!-- Bot√≥n inicial -->
            <div id="entry-container" class="mb-3">
                <button id="start-camera-btn" class="btn btn-primary-soft w-100">
                    <i class="bi bi-camera2"></i> Abrir c√°mara
                </button>

                <input 
                    type="file" 
                    id="photo" 
                    accept="image/*" 
                    capture="environment"
                    style="display:none;">
            </div>

            <!-- TEXTO -->
            <div class="mb-3">
              <label for="dishName" class="form-label">Nombre o descripci√≥n (opcional)</label>
              <input type="text" class="form-control" id="dishName"
                     placeholder="Ej. Enchiladas verdes con pollo">
            </div>

            <div class="mb-3">
              <label for="goal" class="form-label">Objetivo principal</label>
              <select id="goal" class="form-select">
                <option value="calorias">Calor√≠as</option>
                <option value="nutrimental">Informaci√≥n nutrimental</option>
                <option value="indice_glucemico">√çndice gluc√©mico</option>
                <option value="completa" selected>Informaci√≥n completa</option>
              </select>
            </div>

            <button id="analyzeBtn" class="btn btn-primary-soft w-100 mb-2">
              Analizar platillo
            </button>
            <button
              id="useDetectedBtn"
              class="btn btn-primary btn-sm w-100 mt-2"
              style="display:none;">
              <i class="bi bi-arrow-repeat me-1"></i>
              Usar alimento detectado
            </button>

            <p class="small text-muted mb-0">
              *M√°s adelante conectaremos este bot√≥n con IA para calcular calor√≠as, IG, prote√≠na, fibra y grasas.
            </p>

          </div>
        </aside>

        <!-- SECTION: RESULTADOS -->
        <section class="col-12 col-lg-6">
          <div class="card-soft p-3">
            <!-- Cantidad consumida -->
            <div class="mb-4">
              <label class="form-label fw-semibold">
                Cantidad a consumir
              </label>

              <div class="input-group align-items-center">

                <!-- Icono -->
                <span class="input-group-text">
                  <i class="bi bi-knife-fork"></i>
                </span>

                <!-- Input cantidad -->
                <input
                  type="number"
                  id="portionAmount"
                  class="form-control text-center"
                  min="0.25"
                  step="0.25"
                  placeholder="1"
                  style="max-width: 90px;">

                <!-- Selector de unidad -->
                <select id="portionUnit" class="form-select" style="max-width: 130px;">
                  <option value="portion" selected>porciones</option>
                  <option value="grams">gramos</option>
                </select>

              </div>

              <div class="form-text">
                Indica cu√°nto vas a consumir. Puedes usar porciones (¬º, ¬Ω, ¬æ, 1‚Ä¶) o gramos.
              </div>
            </div>

            <div class="card-soft-header">
              <i class="bi bi-bar-chart-steps"></i>
              <span class="result-title">Resultados nutricionales</span>
              <p class="small mb-0 text-muted">Aqu√≠ aparecer√° el resumen del an√°lisis de tu platillo.</p>
            </div>

            <!-- RESUMEN PRINCIPAL -->
            <div id="summary" class="d-flex flex-column gap-3 summary-visible">

              <div>
                <span class="badge px-3 py-2" id="badge-calorias">Calor√≠as: ‚Äî</span>
                <div class="progress mt-1" style="height: 6px;">
                  <div id="progress-calorias" class="progress-bar"></div>
                </div>
              </div>

              <div>
                <span class="badge px-3 py-2" id="badge-ig">√çndice gluc√©mico: ‚Äî</span>
                <div class="progress mt-1" style="height: 6px;">
                  <div id="progress-ig" class="progress-bar"></div>
                </div>
              </div>

              <div>
                <span class="badge px-3 py-2" id="badge-proteina">Prote√≠na: ‚Äî g</span>
                <div class="progress mt-1" style="height: 6px;">
                  <div id="progress-proteina" class="progress-bar"></div>
                </div>
              </div>

              <div>
                <span class="badge px-3 py-2" id="badge-fibra">Fibra: ‚Äî g</span>
                <div class="progress mt-1" style="height: 6px;">
                  <div id="progress-fibra" class="progress-bar"></div>
                </div>
              </div>

              <div>
                <span class="badge px-3 py-2" id="badge-grasa">Grasas totales: ‚Äî g</span>
                <div class="progress mt-1" style="height: 6px;">
                  <div id="progress-grasa" class="progress-bar"></div>
                </div>
              </div>

            </div>

            <!-- Estado: imagen no v√°lida -->
            <div id="invalidImagePanel" class="alert alert-warning d-none text-center mt-3">
              <div class="fs-1 mb-2">üì∑üö´</div>
              <h6 class="fw-semibold">No parece ser un alimento</h6>
              <p id="invalidImageMessage" class="mb-3 small text-muted">
                La imagen no contiene comida reconocible.
              </p>
              <button id="invalidRetryBtn" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-arrow-repeat"></i> Tomar otra foto
              </button>
            </div>

            <!-- ICON GRID -->
            <div class="row row-cols-1 row-cols-md-2 g-4 mt-4">

              <div class="col d-flex align-items-start">
                <div class="icon-square bg-light flex-shrink-0 me-3 d-flex align-items-center justify-content-center"
                    style="width:48px;height:48px;border-radius:12px;">
                  <i class="bi bi-pie-chart-fill fs-4"></i>
                </div>
                <div>
                  <h6 class="fw-bold">Macronutrientes</h6>
                  <p class="text-muted small mb-0">Distribuci√≥n estimada de carbohidratos, prote√≠na y grasa.</p>
                </div>
              </div>

              <div class="col d-flex align-items-start">
                <div class="icon-square bg-light flex-shrink-0 me-3 d-flex align-items-center justify-content-center"
                    style="width:48px;height:48px;border-radius:12px;">
                  <i class="bi bi-graph-up fs-4"></i>
                </div>
                <div>
                  <h6 class="fw-bold">√çndice gluc√©mico</h6>
                  <p class="text-muted small mb-0">Impacto estimado en glucosa del platillo.</p>
                </div>
              </div>

              <div class="col d-flex align-items-start">
                <div class="icon-square bg-light flex-shrink-0 me-3 d-flex align-items-center justify-content-center"
                    style="width:48px;height:48px;border-radius:12px;">
                  <i class="bi bi-droplet-half fs-4"></i>
                </div>
                <div>
                  <h6 class="fw-bold">Tipo de grasas</h6>
                  <p class="text-muted small mb-0">Saturadas, monoinsaturadas y poliinsaturadas.</p>
                </div>
              </div>

              <div class="col d-flex align-items-start">
                <div class="icon-square bg-light flex-shrink-0 me-3 d-flex align-items-center justify-content-center"
                    style="width:48px;height:48px;border-radius:12px;">
                  <i class="bi bi-lightbulb-fill fs-4"></i>
                </div>
                <div>
                  <h6 class="fw-bold">Recomendaciones</h6>
                  <p class="text-muted small mb-0">Tips personalizados seg√∫n tu objetivo.</p>
                </div>
              </div>

            </div>

          </div>
        </section>

      </div>
    </div>
    <!-- Overlay de an√°lisis -->
    <div id="analyzingOverlay" class="analyzing-overlay d-none">
      <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <div class="fw-semibold">Analizando platillo‚Ä¶</div>
        <div class="text-muted small">Esto puede tardar unos segundos</div>
      </div>
    </div>
  </main>
  <!-- MODAL DE MENSAJES -->
  <div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="statusModalTitle">Aviso</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body" id="statusModalBody">
          Mensaje
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cerrar
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="py-2">
    <div class="container-fluid px-3 d-flex flex-column flex-sm-row justify-content-between align-items-center gap-1">
      <span>¬© 2025 NutriVision ¬∑ Demo UI</span>
      <span>Dise√±o mobile-first con Bootstrap 5</span>
    </div>
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/camera.js"></script>
  <script src="js/analyze.js"></script>
  <script src="js/app.js"></script>
<!--
  <script src="js/front.js"></script>
-->
</body>
</html>
